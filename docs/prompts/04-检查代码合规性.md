# 任务 04: 检查代码合规性

## 任务描述
验证生成的基础框架代码是否符合设计文档要求。此任务确保所有数据结构和接口与设计规范完全匹配。

## 前置条件
- 任务 03 成功完成
- 数据可视化框架代码已在 `code/DataCharts-System/` 中生成
- 数据可视化设计文档可用于比较
- 理解设计文档结构

## 任务目标
1. 验证目录结构合规性
2. 根据设计文档验证数据结构
3. 根据设计文档验证接口定义
4. 检查编译状态
5. 生成合规性验证报告

## 详细步骤

### 步骤 1: 目录结构合规性检查
```bash
# 验证目录结构
tree code/DataCharts-System/
ls -la code/DataCharts-System/
```

验证：
- [ ] 正确的模块命名（DataCharts-System）
- [ ] 必需的目录存在（frontend/, backend/, desktop/, shared/）
- [ ] 配置文件存在（package.json, requirements.txt）
- [ ] .gitignore 文件存在
- [ ] 源文件在正确位置

### 步骤 2: 数据结构合规性验证

#### 步骤 2.1: 分析生成的数据结构
```bash
# 从生成的代码中提取数据结构
grep -n "class\|@dataclass" code/DataCharts-System/shared/data_types.py
```

#### 步骤 2.2: 与设计文档交叉引用
将每个数据结构与设计文档比较：

**验证矩阵：**
| 结构名称 | 设计文档章节 | 成员名称匹配 | 数据类型匹配 | 完整性 | 状态 |
|---------|-------------|-------------|-------------|--------|------|
| ChartConfig | [章节 X.X] | [ ] | [ ] | [ ] | [ ] |
| DataSource | [章节 X.X] | [ ] | [ ] | [ ] | [ ] |
| FunctionExpression | [章节 X.X] | [ ] | [ ] | [ ] | [ ] |
| ProcessingResult | [章节 X.X] | [ ] | [ ] | [ ] | [ ] |
| SystemError | [章节 X.X] | [ ] | [ ] | [ ] | [ ] |

#### 步骤 2.3: 详细结构分析
对每个结构，验证：
- **成员名称**: 与设计文档完全匹配
- **成员数据类型**: 与设计文档完全匹配  
- **结构完整性**: 没有缺失成员
- **无增加**: 没有超出设计文档的额外成员
- **无删减**: 没有从设计文档中删除的成员

### 步骤 3: 接口定义合规性验证

#### 步骤 3.1: 分析生成的接口
```bash
# 从生成的代码中提取接口定义
grep -n "def\|class.*Interface" code/DataCharts-System/shared/interfaces.py
```

#### 步骤 3.2: 与设计文档交叉引用
将每个接口与设计文档比较：

**验证矩阵：**
| 接口/函数 | 设计文档章节 | 函数名匹配 | 参数匹配 | 返回类型匹配 | 状态 |
|----------|-------------|-----------|---------|-------------|------|
| DataImportInterface | [章节 X.X] | [ ] | [ ] | [ ] | [ ] |
| FunctionProcessorInterface | [章节 X.X] | [ ] | [ ] | [ ] | [ ] |
| ChartGeneratorInterface | [章节 X.X] | [ ] | [ ] | [ ] | [ ] |
| initialize_system | [章节 X.X] | [ ] | [ ] | [ ] | [ ] |
| shutdown_system | [章节 X.X] | [ ] | [ ] | [ ] | [ ] |

#### 步骤 3.3: 详细接口分析
对每个接口，验证：
- **函数名称**: 与设计文档完全匹配
- **输入参数**: 与设计文档完全匹配（类型、名称、顺序）
- **返回值**: 与设计文档完全匹配
- **接口完整性**: 没有缺失函数
- **无增加**: 没有超出设计文档的额外函数
- **无删减**: 没有从设计文档中删除的函数

### 步骤 4: 编译验证
```bash
cd code/DataCharts-System

# Python 代码检查
python -m py_compile shared/data_types.py 2>&1 | tee compilation-check.log
python -m py_compile shared/interfaces.py 2>&1 | tee -a compilation-check.log
python -m py_compile backend/app/main.py 2>&1 | tee -a compilation-check.log
python -m py_compile desktop/src/main.py 2>&1 | tee -a compilation-check.log

# 前端代码检查（如果可能）
cd frontend && npm install && npm run build 2>&1 | tee ../frontend-build-check.log
```

验证：
- [ ] Python 文件编译通过
- [ ] 前端构建通过
- [ ] 没有与结构定义相关的编译警告
- [ ] 所有必需的类型定义已实现

### 步骤 5: 生成合规性验证报告
创建综合合规性报告：

```markdown
# 数据可视化系统代码合规性验证报告

## 目录结构合规性
**状态**: [通过/失败]
**发现的问题**: [列出任何目录结构问题]

## 数据结构合规性

### 逐结构分析
#### ChartConfig
**设计文档参考**: [章节 X.X]
**状态**: [通过/失败]
**问题**:
- 成员名称不匹配: [列出任何问题]
- 数据类型不匹配: [列出任何问题]
- 缺失成员: [列出任何缺失成员]
- 额外成员: [列出任何额外成员]

#### DataSource
**设计文档参考**: [章节 X.X]
**状态**: [通过/失败]
**问题**: [类似分析]

#### FunctionExpression
**设计文档参考**: [章节 X.X]
**状态**: [通过/失败]
**问题**: [类似分析]

#### ProcessingResult
**设计文档参考**: [章节 X.X]
**状态**: [通过/失败]
**问题**: [类似分析]

#### SystemError
**设计文档参考**: [章节 X.X]
**状态**: [通过/失败]
**问题**: [类似分析]

### 数据结构摘要
**整体状态**: [通过/失败]
**总结构数**: [计数]
**合规结构数**: [计数]
**非合规结构数**: [计数]

## 接口定义合规性

### 逐函数分析
#### DataImportInterface
**设计文档参考**: [章节 X.X]
**状态**: [通过/失败]
**问题**:
- 函数名称: [通过/失败]
- 参数: [列出任何参数不匹配]
- 返回类型: [列出任何返回类型不匹配]

#### FunctionProcessorInterface
**设计文档参考**: [章节 X.X]
**状态**: [通过/失败]
**问题**: [类似分析]

#### ChartGeneratorInterface
**设计文档参考**: [章节 X.X]
**状态**: [通过/失败]
**问题**: [类似分析]

### 接口摘要
**整体状态**: [通过/失败]
**总函数数**: [计数]
**合规函数数**: [计数]
**非合规函数数**: [计数]

## 编译状态
**Python 编译**: [通过/失败]
**前端构建**: [通过/失败]
**错误详情**: [任何编译错误]

## 整体合规性评估
**最终状态**: [通过/失败]
**关键问题**: [列出任何阻塞问题]
**建议**: [任何建议的修复]

## 需要的纠正措施
[列出实现合规性所需的具体措施]
```

## 成功标准
- [ ] 目录结构已根据要求验证
- [ ] 所有数据结构已根据设计文档验证
- [ ] 所有接口定义已根据设计文档验证
- [ ] 编译状态已验证（必须通过）
- [ ] 合规性报告已生成并保存到 `DataCharts-合规性验证报告.md`
- [ ] 明确的合规性状态已确定（通过/失败）

## 输出文件
- `DataCharts-合规性验证报告.md`: 完整合规性验证报告
- `code/DataCharts-System/compilation-check.log`: 编译检查日志
- `code/DataCharts-System/frontend-build-check.log`: 前端构建检查日志

## 触发机制
此任务可通过以下方式触发：
1. 手动执行：人工审查代码与设计文档的对比
2. 脚本执行：`./task-runner.sh 04`
3. AI辅助：使用AI系统性地比较代码与设计文档

## 下一任务
- 如果合规性**通过**：继续执行 **05-编译检查.md**
- 如果合规性**失败**：返回 **03-生成基础框架代码.md** 进行代码修订

## 注意事项
- 专注于精确合规性 - 不允许增加或删除
- 引用特定设计文档部分以确保可追溯性
- 编译必须通过才能认为任务成功
- 最终合规性批准可能需要人工干预